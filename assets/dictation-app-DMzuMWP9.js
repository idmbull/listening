import{D as r,S as s}from"./index-BP5dWznL.js";import{i as v,E as A,a as B,l as D,b as C,c as N,r as E,d as I,s as T,e as k,f as L}from"./drag-drop-CVudGZn6.js";class M{constructor(){this.ctx=null,this.buffer=null,this.currentSource=null,this.gainNode=null,this.volume=1}async load(t){this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext),this.gainNode=this.ctx.createGain(),this.gainNode.gain.value=this.volume,this.gainNode.connect(this.ctx.destination));try{this.buffer=await this.ctx.decodeAudioData(t)}catch(n){console.error("Audio decode error:",n)}}setVolume(t){this.volume=t,this.gainNode&&(this.gainNode.gain.value=t)}stop(){if(this.currentSource){try{this.currentSource.stop()}catch{}this.currentSource.disconnect(),this.currentSource=null}}playSegment(t,n){if(!this.buffer)return;const i=n-t;if(i<=0)return;this.stop();const o=this.ctx.createBufferSource();o.buffer=this.buffer,o.connect(this.gainNode);const a=this.ctx.currentTime;o.start(a,t,i),o.stop(a+i+.003),this.currentSource=o}}const c=new M;let m,g=0;function R(){s.setCurrentSegment(0),L(s.getSource().html),c.stop(),g=0}function S(){const e=s.getSource(),t=e.currentSegment,n=e.segments[t];n&&(c.stop(),c.playSegment(n.audioStart,n.audioEnd))}function U(e,t){if(!t||t.length===0)return 0;let n=0;for(let i=0;i<t.length&&e>=t[i];i++)n=i;return n}async function $(){if(v(),r.volumeInput&&(c.setVolume(parseFloat(r.volumeInput.value)),r.volumeInput.oninput=e=>c.setVolume(parseFloat(e.target.value))),r.textDisplay&&r.textDisplay.addEventListener("dblclick",e=>{if(e.target.tagName!=="SPAN"||e.target.classList.contains("newline-char"))return;const n=s.getState().textSpans.indexOf(e.target);if(n===-1)return;const i=s.getSource(),o=U(n,i.charStarts),a=i.segments[o];a&&(console.log(`Replaying segment ${o}: "${a.text}"`),c.stop(),c.playSegment(a.audioStart,a.audioEnd))}),A.on(B.DICTATION_SEGMENT_CHANGE,e=>{e>g&&(g=e,S())}),await D("dictation"),r.playlistSelect.value){await C(r.playlistSelect.value,"dictation");const e=s.getSource().audioUrl;if(e)try{const t=await(await fetch(e)).arrayBuffer();await c.load(t)}catch(t){console.warn("Init audio failed",t)}}F(),m=new N("dictation",{onReset:R,onLoadContent:async e=>{await C(e,"dictation");const t=s.getSource().audioUrl;if(t)try{const n=await(await fetch(t)).arrayBuffer();await c.load(n)}catch(n){console.warn(n)}},onSectionChange:e=>{I(e),s.setCurrentSegment(0),g=0},onActionStart:()=>{g=s.getSource().currentSegment,S()},onCtrlSpaceSingle:()=>S(),onCtrlSpaceDouble:()=>E()}),window.currentController=m,m.reset(),r.dictationReplayBtn&&(r.dictationReplayBtn.onclick=()=>S())}function F(){const{dictationBtn:e,dictationModal:t,dictationStartBtn:n,dictationCancelBtn:i,dictationSubInput:o,dictationAudioInput:a,dictationBlindMode:b,blindModeToggle:y}=r;e.onclick=l=>{l.preventDefault(),l.stopPropagation(),t.classList.remove("hidden")},i.onclick=()=>t.classList.add("hidden");const w=()=>{n.disabled=!o.files.length||!a.files.length};o.onchange=w,a.onchange=w,T(e,l=>{t.classList.remove("hidden");const u=new DataTransfer,d=new DataTransfer;let f=!1,p=!1;l.forEach(h=>{const x=h.name.toLowerCase();/\.(txt|tsv)$/.test(x)?(u.items.add(h),f=!0):/\.(mp3|wav|ogg)$/.test(x)&&(d.items.add(h),p=!0)}),f&&(o.files=u.files),p&&(a.files=d.files),w()},"Drop Text & Audio!"),n.onclick=async()=>{const l=o.files[0],u=a.files[0];if(!l||!u)return;const d=b.checked;s.setBlindMode(d),y&&(y.checked=d);const f=new FileReader;f.onload=async p=>{await k(p.target.result,l.name,"dictation");const h=await u.arrayBuffer();await c.load(h),s.setSource({...s.getSource(),hasAudio:!0,audioUrl:null}),e.textContent=l.name,t.classList.add("hidden"),m.reset()},f.readAsText(l,"utf-8")}}export{$ as initDictationMode};
